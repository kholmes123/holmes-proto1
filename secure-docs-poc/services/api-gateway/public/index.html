<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Document Redaction and Watermarking</title>
</head>
<body>
  <h1>üìÑ Upload DOCX File for PII Redaction</h1>

  <!-- üîΩ User selects file, engine, and process mode -->
  <form id="redactionForm" enctype="multipart/form-data" method="POST" action="#">
    <label for="file">Select DOCX File:</label>
    <input type="file" name="file" id="file" accept=".docx" required><br><br>

    <!-- Choose PII detection engine -->
    <label>PII Detection Engine:</label><br>
    <input type="radio" name="engine" value="regex" checked> Regex (default)<br>
    <input type="radio" name="engine" value="nlp"> NLP (future feature)<br>
    <input type="radio" name="engine" value="regex2"> Regex (reusing placeholders)<br><br>

    <!-- Choose whether to apply watermark -->
    <label>Processing Type:</label><br>
    <input type="radio" name="mode" value="redact" checked> Redact Only<br>
    <input type="radio" name="mode" value="watermark"> Redact + Watermark<br><br>

    <button type="submit">üöÄ Process File</button>
  </form>

  <div id="responseArea" style="margin-top:20px;"></div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      console.log("üß† Script loaded and DOM ready");
  
      const form = document.getElementById('redactionForm');
      // Debugging: Check if form is loaded
      console.log("üìã Form element:", form);
      
      const responseArea = document.getElementById('responseArea');
  
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log("üöÄ Custom JS form handler triggered");
  
        const fileInput = document.getElementById('file');
        const file = fileInput.files[0];
        if (!file) return alert('Please select a file.');
  
        const engine = document.querySelector('input[name="engine"]:checked').value;
        const mode = document.querySelector('input[name="mode"]:checked').value;
  
        const formData = new FormData();
        formData.append('file', file);
        formData.append('engine', engine);
  
        const endpoint = (mode === 'watermark')
          ? '/process-docx-watermark'
          : '/process-docx';
  
        try {
          const res = await fetch(endpoint, {
            method: 'POST',
            body: formData
          });
  
          if (!res.ok) {
            const error = await res.json();
            responseArea.innerHTML = `<p style="color:red;">‚ùå ${error.error}: ${error.details}</p>`;
            return;
          }
  
          if (mode === 'redact') {
            console.log('üßæ Redact-only mode triggered');
            console.log('üßæ Response status:', res.status);
            console.log('üßæ Response headers:', [...res.headers.entries()]);
  
            const contentType = res.headers.get('Content-Type');
            if (contentType !== 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
              responseArea.innerHTML = `<p style="color:red;">‚ùå Unexpected response format: ${contentType}</p>`;
              return;
            }
  
            const blob = await res.blob();
            console.log('üßæ Blob size:', blob.size);
            console.log('üßæ Blob type:', blob.type);
  
            const downloadUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = downloadUrl;
            a.download = file.name.replace('.docx', '_REDACTED.docx');
            document.body.appendChild(a);
            a.click();
            a.remove();
  
            responseArea.innerHTML = `<p style="color:green;">‚úÖ File redacted and downloaded.</p>`;
  
          } else {
            // Watermark mode ‚Äî JSON response
            const data = await res.json();
  
            responseArea.innerHTML = `
              <p style="color:green;">${data.message}</p>
              <p>${data.watermarkVerified}</p>
              <p><strong>Original Filename:</strong> ${data.originalFilename}</p>
              <p><strong>Generic Filename:</strong> ${data.genericFilename}</p>
              <details style="margin-top: 10px;; color: blue;">
                <summary>üìú Click to Show Extracted Watermark Text</summary>
                <pre style="background: #f0f0f0; padding: 10px; border-radius: 5px;">${data.extractedWatermarkText || '‚ö†Ô∏è No watermark text found.'}</pre>
              </details>
            `;
          }
  
        } catch (err) {
          console.error(err);
          responseArea.innerHTML = `<p style="color:red;">Unexpected error occurred.</p>`;
        }
      });
    });
  </script>


</body>
</html>